name: Taro React Build

on:
  push:
    branches: [main, master]
    paths:
      - 'packages/demo-taro-react/**'
      - '.github/workflows/taro-react.yaml'
  pull_request:
    branches: [main, master]
    paths:
      - 'packages/demo-taro-react/**'

jobs:
  test-and-lint:
    name: Test & Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn install --frozen-lockfile
        
      - name: Lint Taro app
        run: yarn workspace demo-taro-react lint
        
      - name: Test Taro app
        run: yarn workspace demo-taro-react test
  
  build:
    name: Multi-platform Build
    runs-on: ubuntu-latest
    needs: test-and-lint
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      
      - name: Build for H5
        run: yarn workspace demo-taro-react build:h5
        
      - name: Build for WeChat Mini Program
        run: yarn workspace demo-taro-react build:weapp
      
      - name: Upload H5 artifacts
        uses: actions/upload-artifact@v3
        with:
          name: h5-build
          path: packages/demo-taro-react/dist
          
      - name: Upload WeChat Mini Program artifacts
        uses: actions/upload-artifact@v3
        with:
          name: weapp-build
          path: packages/demo-taro-react/dist/weapp
      
      # 如果需要部署到小程序 CI，可以添加相关步骤
      # 例如：
      # - name: WeChat Mini Program CI
      #   uses: wechat-miniprogram/miniprogram-ci-action@main
      #   with:
      #     command: upload
      #     privateKeyPath: ${{ secrets.WX_PRIVATE_KEY }}
      #     projectPath: packages/demo-taro-react/dist/weapp
      #     appid: ${{ secrets.WX_APPID }}
      #     version: 1.0.0
      #     desc: 'Release from GitHub Actions' 